{% extends 'base.html' %}
{% load static %}
{% block title %}Mavzu: {{ topic.name }}{% endblock %}
{% block content %}
<div class="space-y-4 max-w-4xl mx-auto">
  <div class="bg-white shadow-lg rounded-xl p-6 border-2 border-gray-100">
    <div class="mb-4 pb-4 border-b-2 border-gray-200">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ topic.name }}</h1>
      <p class="text-sm text-gray-500">
        <i class="fas fa-bookmark text-indigo-500"></i> Modul: {{ topic.module.name }} | 
        <i class="fas fa-clock text-blue-500"></i> {{ topic.duration_minutes }} daqiqa
      </p>
    </div>
    {% if topic.description %}
    <div class="prose prose-lg max-w-none mt-4">
      {{ topic.description|safe }}
    </div>
    {% else %}
    <p class="text-gray-500 italic">Tavsif mavjud emas.</p>
    {% endif %}
  </div>

  <div class="bg-white shadow rounded-lg p-6 space-y-3">
    <h2 class="text-lg font-semibold">Materiallar</h2>
    <div class="space-y-2">
      {% for material in topic.materials.all %}
      <div class="border rounded-lg p-3">
        <p class="font-semibold">{{ material.title }}</p>
        <p class="text-sm text-gray-600">{{ material.description|default:"" }}</p>
        {% if material.link %}
          <a class="text-blue-600 hover:text-blue-800 text-sm" href="{{ material.link }}" target="_blank">Link</a>
        {% endif %}
      </div>
      {% empty %}
      <p class="text-gray-500 text-sm">Materiallar mavjud emas.</p>
      {% endfor %}
    </div>
  </div>

  {% if can_edit_lessons and lessons %}
  <div class="bg-white shadow rounded-lg p-6 space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">Bu mavzudagi darslar</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Sana</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Vaqt</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Guruh</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Mavzu</th>
            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Amallar</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for lesson in lessons %}
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm text-gray-900">{{ lesson.date|date:"d.m.Y" }}</td>
            <td class="px-4 py-3 text-sm text-gray-700">
              {% if lesson.start_time %}{{ lesson.start_time|time:"H:i" }}{% if lesson.end_time %} - {{ lesson.end_time|time:"H:i" }}{% endif %}{% else %}-{% endif %}
            </td>
            <td class="px-4 py-3 text-sm text-gray-900">{{ lesson.group.name }}</td>
            <td class="px-4 py-3 text-sm text-gray-700">{{ lesson.title|default:"-" }}</td>
            <td class="px-4 py-3 text-center">
              <button onclick="openLessonEditModal({{ lesson.pk }}, '{{ lesson.title|default:""|escapejs }}', '{{ lesson.date|date:"Y-m-d" }}', '{{ lesson.start_time|time:"H:i"|default:"" }}', '{{ lesson.end_time|time:"H:i"|default:"" }}', '{{ lesson.description|default:""|escapejs }}', '{{ lesson.notes|default:""|escapejs }}', '{{ lesson.questions|default:""|escapejs }}')" 
                      class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold transition">
                <i class="fas fa-edit mr-1"></i>Tahrirlash
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
</div>

<!-- Lesson Edit Modal -->
<div id="lessonEditModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen px-4">
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="closeLessonEditModal()"></div>
    <div class="relative bg-white rounded-xl shadow-xl max-w-2xl w-full p-6 transform transition-all">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-gray-900">Darsni tahrirlash</h3>
        <button onclick="closeLessonEditModal()" class="text-gray-400 hover:text-gray-600 transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <form method="post" id="lessonEditForm" action="" class="space-y-4">
        {% csrf_token %}
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Sana</label>
            <input type="date" name="date" id="edit_lesson_date" 
                   class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition">
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Boshlanish</label>
              <input type="time" name="start_time" id="edit_lesson_start_time" 
                     class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition">
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Tugash</label>
              <input type="time" name="end_time" id="edit_lesson_end_time" 
                     class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition">
            </div>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Sarlavha</label>
          <input type="text" name="title" id="edit_lesson_title" 
                 class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition">
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Tavsif</label>
          <textarea name="description" id="edit_lesson_description" rows="3" 
                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition"></textarea>
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Eslatmalar</label>
          <textarea name="notes" id="edit_lesson_notes" rows="3" 
                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition"></textarea>
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Savollar</label>
          <textarea name="questions" id="edit_lesson_questions" rows="3" 
                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition"></textarea>
        </div>
        
        <div class="flex gap-3 pt-4 border-t border-gray-200">
          <button type="submit" 
                  class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition font-semibold">
            Saqlash
          </button>
          <button type="button" 
                  onclick="closeLessonEditModal()"
                  class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold">
            Bekor qilish
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function openLessonEditModal(lessonId, title, date, startTime, endTime, description, notes, questions) {
  const modal = document.getElementById('lessonEditModal');
  const form = document.getElementById('lessonEditForm');
  
  form.action = `/courses/lessons/${lessonId}/edit/`;
  document.getElementById('edit_lesson_title').value = title || '';
  document.getElementById('edit_lesson_date').value = date || '';
  document.getElementById('edit_lesson_start_time').value = startTime || '';
  document.getElementById('edit_lesson_end_time').value = endTime || '';
  
  // CKEditor instance'lari mavjud bo'lsa, ularni yangilash, aks holda yaratish
  if (typeof CKEDITOR !== 'undefined') {
    // Description
    if (CKEDITOR.instances['edit_lesson_description']) {
      CKEDITOR.instances['edit_lesson_description'].setData(description || '');
    } else {
      CKEDITOR.replace('edit_lesson_description', {
        toolbar: 'full',
        height: 300,
        width: '100%',
        language: 'en',
        versionCheck: false
      });
      CKEDITOR.instances['edit_lesson_description'].setData(description || '');
    }
    
    // Notes
    if (CKEDITOR.instances['edit_lesson_notes']) {
      CKEDITOR.instances['edit_lesson_notes'].setData(notes || '');
    } else {
      CKEDITOR.replace('edit_lesson_notes', {
        toolbar: 'full',
        height: 300,
        width: '100%',
        language: 'en',
        versionCheck: false
      });
      CKEDITOR.instances['edit_lesson_notes'].setData(notes || '');
    }
    
    // Questions
    if (CKEDITOR.instances['edit_lesson_questions']) {
      CKEDITOR.instances['edit_lesson_questions'].setData(questions || '');
    } else {
      CKEDITOR.replace('edit_lesson_questions', {
        toolbar: 'full',
        height: 300,
        width: '100%',
        language: 'en',
        versionCheck: false
      });
      CKEDITOR.instances['edit_lesson_questions'].setData(questions || '');
    }
  } else {
    // CKEditor yuklanmagan bo'lsa, oddiy textarea'larni to'ldirish
    document.getElementById('edit_lesson_description').value = description || '';
    document.getElementById('edit_lesson_notes').value = notes || '';
    document.getElementById('edit_lesson_questions').value = questions || '';
  }
  
  modal.classList.remove('hidden');
}

function closeLessonEditModal() {
  const modal = document.getElementById('lessonEditModal');
  modal.classList.add('hidden');
}

// Form submission
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('lessonEditForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // CKEditor ma'lumotlarini olish
      if (typeof CKEDITOR !== 'undefined') {
        for (let instance in CKEDITOR.instances) {
          CKEDITOR.instances[instance].updateElement();
        }
      }
      
      const formData = new FormData(form);
      
      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Xatolik: ' + (data.message || 'Noma\'lum xatolik'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Xatolik yuz berdi');
      });
    });
  }
});
</script>
{% endblock %}

