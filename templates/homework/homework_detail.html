{% extends 'base.html' %}
{% load static %}

{% block title %}Uy vazifasi: {{ homework.title }} | GEEKS CRM{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header Card -->
    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex flex-col sm:flex-row items-center sm:items-start justify-between gap-4">
            <div class="flex-1 text-center sm:text-left">
                <h1 class="text-3xl font-bold mb-3">{{ homework.title }}</h1>
                <div class="flex flex-wrap items-center justify-center sm:justify-start gap-4 text-sm">
                    {% if homework.lesson and homework.lesson.group %}
                    <span class="flex items-center gap-2 bg-white bg-opacity-20 px-4 py-2 rounded-lg backdrop-blur-sm">
                        <i class="fas fa-users"></i>
                        <span class="font-semibold">{{ homework.lesson.group.name }}</span>
                    </span>
                    {% endif %}
                    <span class="flex items-center gap-2 bg-white bg-opacity-20 px-4 py-2 rounded-lg backdrop-blur-sm">
                        <i class="fas fa-calendar"></i>
                        <span class="font-semibold">Muddati: {{ homework.deadline|date:"d.m.Y" }}</span>
                    </span>
                    {% if homework.deadline < today %}
                    <span class="px-4 py-2 bg-red-500 bg-opacity-30 rounded-lg backdrop-blur-sm font-semibold">
                        <i class="fas fa-exclamation-triangle"></i> Kechikkan
                    </span>
                    {% endif %}
                </div>
            </div>
            {% if can_edit %}
            <div class="flex gap-2">
                <a href="{% url 'homework:homework_edit' homework.pk %}" 
                   class="bg-white text-orange-600 px-5 py-2.5 rounded-lg hover:bg-orange-50 transition-all font-semibold shadow-lg transform hover:scale-105 flex items-center gap-2">
                    <i class="fas fa-edit"></i>
                    <span>Tahrirlash</span>
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Mentor uchun: Barcha o'quvchilar uchun yaratilgan vazifalar jadvali -->
    {% if is_group_homework and user.role == 'mentor' and related_homeworks %}
    <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
            <i class="fas fa-users text-orange-600"></i>
            Barcha o'quvchilar uchun vazifalar
        </h2>
        <div class="overflow-x-auto">
            <table class="w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">O'quvchi</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Status</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Topshirilgan</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Baho</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Amallar</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for hw in related_homeworks %}
                    <tr class="hover:bg-gray-50 transition {% if hw.pk == homework.pk %}bg-orange-50{% endif %}">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                    {{ hw.student.first_name.0|upper|default:hw.student.username.0|upper }}
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-900">{{ hw.student.get_full_name|default:hw.student.username }}</p>
                                    <p class="text-xs text-gray-500">{{ hw.student.username }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if hw.grade %}
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">Baholangan</span>
                            {% elif hw.is_submitted %}
                                <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">Topshirilgan</span>
                            {% elif hw.deadline|date:"Y-m-d" < today|date:"Y-m-d" %}
                                <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">Kechikkan</span>
                            {% else %}
                                <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-semibold">Kutilmoqda</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if hw.submitted_at %}
                                <span class="text-sm text-gray-700">{{ hw.submitted_at|date:"d.m.Y H:i" }}</span>
                            {% else %}
                                <span class="text-sm text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if hw.grade %}
                                <div class="flex items-center justify-center gap-2">
                                    <span class="text-lg font-bold text-gray-900">{{ hw.grade.grade }}</span>
                                    <span class="text-xs text-gray-500">/100</span>
                                </div>
                            {% else %}
                                <span class="text-sm text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <a href="{% url 'homework:homework_detail' hw.pk %}" 
                                   class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-semibold transition flex items-center gap-1">
                                    <i class="fas fa-eye"></i>
                                    <span>Ko'rish</span>
                                </a>
                                {% if hw.is_submitted and can_grade %}
                                <a href="{% url 'homework:homework_grade' hw.pk %}" 
                                   class="px-3 py-1.5 {% if hw.grade %}bg-blue-500 hover:bg-blue-600{% else %}bg-yellow-500 hover:bg-yellow-600{% endif %} text-white rounded-lg text-xs font-semibold transition flex items-center gap-1">
                                    <i class="fas {% if hw.grade %}fa-edit{% else %}fa-star{% endif %}"></i>
                                    <span>{% if hw.grade %}Qayta baholash{% else %}Baholash{% endif %}</span>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Assignment Description (Mentor tomonidan yozilgan) -->
    {% if homework.assignment_description %}
    <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
            <i class="fas fa-file-alt text-orange-600"></i>
            Vazifa tavsifi
        </h2>
        <div class="text-gray-700 leading-relaxed prose max-w-none">{{ homework.assignment_description|safe }}</div>
    </div>
    {% endif %}
    
    <!-- Student Response (Student tomonidan yozilgan) - Faqat student uchun -->
    {% if user.role == 'student' and homework.student_response %}
    <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
            <i class="fas fa-comment text-blue-600"></i>
            Mening javobim
        </h2>
        <div class="text-gray-700 leading-relaxed prose max-w-none">{{ homework.student_response|safe }}</div>
    </div>
    {% endif %}

    <!-- Files and Links -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% if homework.file %}
        <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
            <h2 class="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
                <i class="fas fa-file text-orange-600"></i>
                Fayl
            </h2>
            <a href="{{ homework.file.url }}" 
               target="_blank"
               class="inline-flex items-center gap-3 px-5 py-3 bg-orange-50 border-2 border-orange-200 rounded-lg hover:bg-orange-100 transition text-sm font-semibold text-orange-700">
                <i class="fas fa-download"></i>
                <span>Faylni yuklab olish</span>
            </a>
        </div>
        {% endif %}
        
        {% if homework.link %}
        <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
            <h2 class="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
                <i class="fas fa-link text-orange-600"></i>
                Havola
            </h2>
            <a href="{{ homework.link }}" 
               target="_blank"
               class="inline-flex items-center gap-3 px-5 py-3 bg-orange-50 border-2 border-orange-200 rounded-lg hover:bg-orange-100 transition text-sm font-semibold text-orange-700 break-all">
                <i class="fas fa-external-link-alt"></i>
                <span>{{ homework.link|truncatechars:40 }}</span>
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Grade Section -->
    {% if homework.grade %}
    <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                <i class="fas fa-star text-yellow-500"></i>
                Baho
            </h2>
            {% if can_grade %}
            <a href="{% url 'homework:homework_grade' homework.pk %}" 
               class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white rounded-lg transition font-semibold shadow-md hover:shadow-lg flex items-center gap-2 text-sm">
                <i class="fas fa-edit"></i>
                <span>Qayta baholash</span>
            </a>
            {% endif %}
        </div>
        <div class="flex items-center gap-4">
            <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center text-white text-3xl font-bold shadow-lg">
                {{ homework.grade.grade }}
            </div>
            <div class="flex-1">
                <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-1">Baholangan</p>
                <p class="text-lg font-bold text-gray-900">{{ homework.grade.graded_at|date:"d.m.Y H:i" }}</p>
                {% if homework.grade.mentor %}
                <p class="text-sm text-gray-600 mt-1">Baholagan: {{ homework.grade.mentor.get_full_name|default:homework.grade.mentor.username }}</p>
                {% endif %}
                {% if homework.grade.comment %}
                <div class="text-gray-700 mt-2 prose max-w-none">{{ homework.grade.comment|safe }}</div>
                {% endif %}
            </div>
        </div>
    </div>
    {% elif can_grade and homework.is_submitted %}
    <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-star text-yellow-500"></i>
                    Baholash
                </h2>
                <p class="text-gray-600 text-sm mt-1">Vazifa topshirilgan, baholash mumkin</p>
            </div>
            <a href="{% url 'homework:homework_grade' homework.pk %}" 
               class="px-5 py-2.5 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white rounded-lg transition font-semibold shadow-md hover:shadow-lg flex items-center gap-2">
                <i class="fas fa-star"></i>
                <span>Baholash</span>
            </a>
        </div>
    </div>
    {% elif can_grade and not homework.is_submitted %}
    <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-clock text-gray-500"></i>
                    Baholash
                </h2>
                <p class="text-gray-600 text-sm mt-1">Vazifa hali topshirilmagan</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Submission Form (for students) -->
    {% if can_submit %}
    <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
            <i class="fas fa-upload text-orange-600"></i>
            Vazifani topshirish
        </h2>
        <form method="post" action="{% url 'homework:homework_submit' homework.pk %}" enctype="multipart/form-data" class="space-y-4" x-data="{loading: false}" @submit.prevent="loading=true; $el.submit()">
            {% csrf_token %}
            
            <!-- File Upload -->
            <div>
                <label for="file" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-file text-orange-600 mr-1"></i>
                    Fayl yuklash
                </label>
                <input type="file" 
                       name="file" 
                       id="file"
                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition text-sm">
                <p class="mt-1 text-xs text-gray-500">PDF, Word, ZIP va boshqa formatlar qabul qilinadi</p>
            </div>
            
            <!-- Link -->
            <div>
                <label for="link" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-link text-orange-600 mr-1"></i>
                    Havola (GitHub, CodePen, va h.k.)
                </label>
                <input type="url" 
                       name="link" 
                       id="link"
                       value="{{ homework.link|default:'' }}"
                       placeholder="https://github.com/..."
                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition text-sm">
            </div>
            
            <!-- Code -->
            <div>
                <label for="code" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-code text-orange-600 mr-1"></i>
                    Kod matni
                </label>
                <textarea name="code" 
                          id="code"
                          rows="8"
                          placeholder="Kodingizni bu yerga kiriting..."
                          class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition text-sm font-mono resize-none">{{ homework.code|default:'' }}</textarea>
            </div>
            
            <!-- Student Response -->
            <div>
                <label for="student_response" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-comment text-orange-600 mr-1"></i>
                    Javob/Izoh (ixtiyoriy)
                </label>
                <textarea name="student_response" 
                          id="student_response"
                          rows="4"
                          placeholder="Vazifa haqida qo'shimcha izoh yozing..."
                          class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition text-sm resize-none">{{ homework.student_response|default:'' }}</textarea>
            </div>
            
            <!-- Submit Button -->
            <div class="flex items-center justify-end gap-3 pt-4 border-t">
                <button type="submit" 
                        :disabled="loading"
                        class="px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white rounded-lg transition font-semibold shadow-md hover:shadow-lg disabled:opacity-50 flex items-center gap-2">
                    <i class="fas" :class="{'fa-spin fa-spinner': loading, 'fa-paper-plane': !loading}"></i>
                    <span x-text="loading ? 'Topshirilmoqda...' : 'Topshirish'">Topshirish</span>
                </button>
            </div>
        </form>
    </div>
    {% endif %}
    
    <!-- Submission Info -->
    {% if homework.submitted_at %}
    <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
            <i class="fas fa-check-circle text-green-600"></i>
            Topshirilgan
        </h2>
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <span class="text-sm font-semibold text-gray-500">Topshirilgan sana:</span>
                <span class="text-sm font-bold text-gray-900">{{ homework.submitted_at|date:"d.m.Y H:i" }}</span>
            </div>
            {% if homework.file %}
            <div>
                <span class="text-sm font-semibold text-gray-500 block mb-2">Topshirilgan fayl:</span>
                <a href="{{ homework.file.url }}" 
                   target="_blank"
                   class="inline-flex items-center gap-2 px-4 py-2 bg-green-50 border-2 border-green-200 rounded-lg hover:bg-green-100 transition text-sm font-semibold text-green-700">
                    <i class="fas fa-file-download"></i>
                    <span>Faylni ko'rish</span>
                </a>
            </div>
            {% endif %}
            {% if homework.link %}
            <div>
                <span class="text-sm font-semibold text-gray-500 block mb-2">Havola:</span>
                <a href="{{ homework.link }}" 
                   target="_blank"
                   class="inline-flex items-center gap-2 px-4 py-2 bg-blue-50 border-2 border-blue-200 rounded-lg hover:bg-blue-100 transition text-sm font-semibold text-blue-700 break-all">
                    <i class="fas fa-external-link-alt"></i>
                    <span>{{ homework.link|truncatechars:50 }}</span>
                </a>
            </div>
            {% endif %}
            {% if homework.code %}
            <div>
                <span class="text-sm font-semibold text-gray-500 block mb-2">Kod:</span>
                <pre class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4 text-xs overflow-x-auto"><code>{{ homework.code }}</code></pre>
            </div>
            {% endif %}
            {% if homework.student_response and user.role == 'student' %}
            <div>
                <span class="text-sm font-semibold text-gray-500 block mb-2">Mening javobim/Izohim:</span>
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 text-sm text-gray-700 prose max-w-none">
                    {{ homework.student_response|safe }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- Mentor uchun: O'quvchi javobini ko'rish (agar topshirilgan bo'lsa) -->
    {% if user.role == 'mentor' or user.role == 'admin' or user.role == 'manager' %}
        {% if homework.is_submitted and homework.student_response %}
        <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <i class="fas fa-comment-dots text-blue-600"></i>
                O'quvchi javobi
            </h2>
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-6">
                <div class="flex items-start gap-3 mb-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold">
                        {{ homework.student.first_name.0|upper|default:homework.student.username.0|upper }}
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900">{{ homework.student.get_full_name|default:homework.student.username }}</p>
                        <p class="text-xs text-gray-500">{{ homework.submitted_at|date:"d.m.Y H:i" }} da topshirilgan</p>
                    </div>
                </div>
                <div class="text-gray-700 leading-relaxed prose max-w-none mt-4">
                    {{ homework.student_response|safe }}
                </div>
            </div>
        </div>
        {% endif %}
    {% endif %}

    <!-- Quick Info -->
    <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
        <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <i class="fas fa-info-circle text-orange-600"></i>
            Ma'lumotlar
        </h2>
        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
            <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                <dt class="text-gray-600">Guruh</dt>
                <dd class="font-semibold text-gray-900">
                    {% if homework.lesson and homework.lesson.group %}
                    <a href="{% url 'courses:group_detail' homework.lesson.group.pk %}" 
                       class="text-orange-600 hover:text-orange-800">
                        {{ homework.lesson.group.name }}
                    </a>
                    {% else %}-{% endif %}
                </dd>
            </div>
            <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                <dt class="text-gray-600">Dars</dt>
                <dd class="font-semibold text-gray-900">
                    {% if homework.lesson %}
                    <a href="{% url 'courses:lesson_detail' homework.lesson.pk %}" 
                       class="text-orange-600 hover:text-orange-800">
                        {{ homework.lesson.title|default:"Dars" }}
                    </a>
                    {% else %}
                    <span class="text-gray-400">-</span>
                    {% endif %}
                </dd>
            </div>
            <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                <dt class="text-gray-600">Muddati</dt>
                <dd class="font-semibold text-gray-900">{{ homework.deadline|date:"d.m.Y" }}</dd>
            </div>
            <div class="flex justify-between items-center">
                <dt class="text-gray-600">Status</dt>
                <dd class="font-semibold">
                    {% if homework.grade %}
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs">Baholangan</span>
                    {% elif homework.submitted_at %}
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">Topshirilgan</span>
                    {% elif homework.deadline < today %}
                    <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs">Kechikkan</span>
                    {% else %}
                    <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs">Kutilmoqda</span>
                    {% endif %}
                </dd>
            </div>
        </dl>
    </div>
</div>
{% endblock %}
