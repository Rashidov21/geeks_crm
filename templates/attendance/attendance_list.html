{% extends 'base.html' %}
{% load static %}
{% block title %}Davomat | GEEKS CRM{% endblock %}
{% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
        <i class="fas fa-calendar-check text-green-600"></i>
        Davomat
      </h1>
      <p class="text-gray-600 mt-1">O'quvchilarning darsga qatnash tarixi</p>
    </div>
    {% if user.role == 'mentor' or user.role == 'admin' or user.role == 'manager' %}
      <a href="{% url 'attendance:attendance_form' %}" 
         class="flex items-center gap-2 bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-lg hover:shadow-lg transition font-medium">
        <i class="fas fa-plus-circle"></i>
        <span>Davomat kiritish</span>
      </a>
    {% endif %}
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg shadow-lg p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-green-100 text-sm">Keldi</p>
          <p class="text-3xl font-bold mt-1">{{ present_count|default:"0" }}</p>
        </div>
        <i class="fas fa-check-circle text-3xl opacity-30"></i>
      </div>
    </div>
    <div class="bg-gradient-to-br from-yellow-500 to-orange-500 text-white rounded-lg shadow-lg p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-yellow-100 text-sm">Kech qoldi</p>
          <p class="text-3xl font-bold mt-1">{{ late_count|default:"0" }}</p>
        </div>
        <i class="fas fa-clock text-3xl opacity-30"></i>
      </div>
    </div>
    <div class="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-lg shadow-lg p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-red-100 text-sm">Kelmadi</p>
          <p class="text-3xl font-bold mt-1">{{ absent_count|default:"0" }}</p>
        </div>
        <i class="fas fa-times-circle text-3xl opacity-30"></i>
      </div>
    </div>
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg shadow-lg p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-blue-100 text-sm">Umumiy foiz</p>
          <p class="text-3xl font-bold mt-1">{{ attendance_percentage|default:"0"|floatformat:0 }}%</p>
        </div>
        <i class="fas fa-chart-pie text-3xl opacity-30"></i>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-xl shadow-md p-4">
    <div class="flex flex-col md:flex-row gap-3">
      <div class="flex-1 relative">
        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        <input type="text" placeholder="O'quvchi ismi bo'yicha qidirish..." 
               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
      </div>
      <input type="date" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
        <option value="">Barcha statuslar</option>
        <option value="present">Keldi</option>
        <option value="late">Kech qoldi</option>
        <option value="absent">Kelmadi</option>
      </select>
    </div>
  </div>

  <!-- Attendance Table -->
  {% if attendances %}
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                <i class="fas fa-calendar mr-2"></i>Sana
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                <i class="fas fa-user mr-2"></i>O'quvchi
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                <i class="fas fa-book mr-2"></i>Dars
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                <i class="fas fa-users mr-2"></i>Guruh
              </th>
              <th class="px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                <i class="fas fa-check-circle mr-2"></i>Status
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for a in attendances %}
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center gap-2">
                    <div class="text-center">
                      <p class="text-sm font-bold text-gray-900">{{ a.lesson.date|date:"d" }}</p>
                      <p class="text-xs text-gray-500">{{ a.lesson.date|date:"M" }}</p>
                    </div>
                    <div class="text-xs text-gray-600">
                      <p>{{ a.lesson.start_time }}</p>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold">
                      {{ a.student.first_name.0|upper }}{{ a.student.last_name.0|default:""|upper }}
                    </div>
                    <div>
                      <p class="text-sm font-semibold text-gray-900">{{ a.student.get_full_name|default:a.student.username }}</p>
                      <p class="text-xs text-gray-500">{{ a.student.phone|default:"-" }}</p>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <p class="text-sm text-gray-900">{{ a.lesson.topic_covered|default:"Mavzu belgilanmagan"|truncatewords:8 }}</p>
                  <p class="text-xs text-gray-500 mt-1"><i class="fas fa-map-marker-alt"></i> {{ a.lesson.room.name }}</p>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="inline-flex items-center gap-1 px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs font-medium">
                    <i class="fas fa-layer-group"></i>
                    {{ a.lesson.group.name }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                  <span class="inline-flex items-center gap-1 px-4 py-2 text-sm font-semibold rounded-full shadow-sm
                    {% if a.status == 'present' %}bg-green-100 text-green-800 border-2 border-green-500
                    {% elif a.status == 'late' %}bg-yellow-100 text-yellow-800 border-2 border-yellow-500
                    {% else %}bg-red-100 text-red-800 border-2 border-red-500{% endif %}">
                    <i class="fas {% if a.status == 'present' %}fa-check-circle{% elif a.status == 'late' %}fa-clock{% else %}fa-times-circle{% endif %}"></i>
                    {{ a.get_status_display }}
                  </span>
                  {% if a.notes %}
                    <div class="mt-1 group relative inline-block">
                      <i class="fas fa-comment-alt text-gray-400 cursor-help"></i>
                      <div class="hidden group-hover:block absolute z-10 bg-gray-900 text-white text-xs rounded p-2 w-48 bottom-full mb-2 left-1/2 transform -translate-x-1/2">
                        {{ a.notes }}
                      </div>
                    </div>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <div class="bg-white rounded-xl shadow-lg p-12 text-center">
      <div class="max-w-md mx-auto">
        <div class="bg-gray-100 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-calendar-times text-4xl text-gray-400"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">Davomat ma'lumotlari topilmadi</h3>
        <p class="text-gray-600 mb-6">Hozircha hech qanday davomat kiritilmagan.</p>
        {% if user.role == 'mentor' or user.role == 'admin' or user.role == 'manager' %}
          <a href="{% url 'attendance:attendance_form' %}" 
             class="inline-flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
            <i class="fas fa-plus"></i>
            <span>Davomat kiritish</span>
          </a>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

